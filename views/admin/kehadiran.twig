<style>
    table, tr, th, td {
        border: 1px solid black;
        border-collapse: collapse;
        padding: 10px;
        text-align: center;
        max-width: 100vw;
    }
</style>

<small>Drag rows to reorder</small>
<table id="editable-table">
    <!-- Initial table content -->
    <thead>
    <tr>
        <th>Aktiviti No.</th>
        <th>Attendance</th>
        <th>Delete Aktiviti Attendance Record</th>
    </tr>
    </thead>
    <tbody>
    {% for key, value in data.kehadiran %}
        <tr>
            <td>#{{ key+1 }}</td>
            <td><input type="checkbox" {{ value ? 'checked="true"' : '' }}></td>
            <td><button class="delete-row">Delete</button></td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<button id="add-row">Add Row</button>
<button id="submit-table">Submit</button>

<script src="{{ js('jquery.js') }}"></script>
<script src="{{ js('jquery-ui.js') }}"></script>
<script src="{{ css('jquery-ui.css') }}"></script>
<script>
    $(document).ready(function () {
        // Add Row functionality
        $('#add-row').click(function () {
            let rowCount = $('#editable-table tbody tr').length;
            let newRow = '<tr>' +
                '<td>#' + (rowCount + 1) + '</td>' +
                '<td><input type="checkbox"></td>' +
                '<td><button class="delete-row">Delete</button></td>' +
                '</tr>';
            $('#editable-table tbody').append(newRow);
        });

        // Delete Row functionality
        $(document).on('click', '.delete-row', function () {
            $(this).closest('tr').remove();
            // Update Aktiviti No. after deleting a row
            updateAktivitiNumbers();
        });

        // Function to update Aktiviti No. after deleting a row
        function updateAktivitiNumbers() {
            $('#editable-table tbody tr').each(function (index) {
                $(this).find('td:first').text('#' + (index + 1));
            });
        }

        // Make the rows sortable
        $('#editable-table tbody').sortable({
            update: function () {
                updateAktivitiNumbers();
            }
        });

        $('#submit-table').on('click', function () {
            let data = [];
            $('#editable-table tbody tr').each(function () {
                $(this).find('td').each(function (index) {
                    let value = $(this).find('input[type="checkbox"]').prop('checked');
                    if (value !== undefined) {
                        data.push(value)
                    }
                });
            });

            // console.log(data);

            $.ajax({
                url: '/users/{{ data.idMurid }}/kehadiran',
                method: 'POST',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({ data }),
                success: function (res) {
                    console.log(res)
                    if (res.success) {
                        alert(`Announcements updated successfully!`);
                    } else {
                        alert('Announcements failed to be updated (Internal server error)');
                    }
                },
                error: function (e) {
                    alert(`Announcements failed to be updated. (Ajax error)`);
                    console.error(e);
                }
            }).then(function () {
                location.reload();
            });
        });
    })
</script>